<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 3.9.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>MIT-6.828-LAB5 File system,Spawn and Shell - YanTang Qin的博客</title>


    <meta name="description" content="Contents File system preliminaries Block Layout and struct File Design Philosophy of File System   The File System Exercise 1 - Disk Access Question   Exercise 2 - The Block Cache Challenge - Block Ev">
<meta name="keywords" content="MIT6.828">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT-6.828-LAB5 File system,Spawn and Shell">
<meta property="og:url" content="https://qinstaunch.github.io/2020/01/31/MIT-6-828-LAB5-File-system-Spawn-and-Shell/index.html">
<meta property="og:site_name" content="YanTang Qin的博客">
<meta property="og:description" content="Contents File system preliminaries Block Layout and struct File Design Philosophy of File System   The File System Exercise 1 - Disk Access Question   Exercise 2 - The Block Cache Challenge - Block Ev">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://qinstaunch.github.io/images/og_image.png">
<meta property="og:updated_time" content="2020-01-31T15:22:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT-6.828-LAB5 File system,Spawn and Shell">
<meta name="twitter:description" content="Contents File system preliminaries Block Layout and struct File Design Philosophy of File System   The File System Exercise 1 - Disk Access Question   Exercise 2 - The Block Cache Challenge - Block Ev">
<meta name="twitter:image" content="https://qinstaunch.github.io/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.png" alt="MIT-6.828-LAB5 File system,Spawn and Shell" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">目录</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于我</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-01-31T14:36:42.000Z">2020-01-31</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/操作系统/">操作系统</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/操作系统/MIT-6-828-OSE/">MIT-6.828-OSE</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    37 分钟 读完 (大约 5492 个字)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span>次访问
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                MIT-6.828-LAB5 File system,Spawn and Shell
            
        </h1>
        <div class="content">
            <html><head></head><body><h1><span id="contents"><span>Contents</span></span><a href="#contents" class="header-anchor">#</a></h1><ul>
<li><a href="#OSELAB5_A">File system preliminaries</a><ul>
<li><a href="#OSELAB5_A.1">Block Layout and struct File</a></li>
<li><a href="#OSELAB5_A.2">Design Philosophy of File System</a></li>
</ul>
</li>
<li><a href="#OSELAB5_B">The File System</a><ul>
<li><a href="#OSELAB5_B.1">Exercise 1 - Disk Access</a><ul>
<li><a href="#OSELAB5_B.1.QUESTION">Question</a></li>
</ul>
</li>
<li><a href="#OSELAB5_B.2">Exercise 2 - The Block Cache</a><ul>
<li><a href="#OSELAB5_B.2.CHALLENGE">Challenge - Block Eviction Policy</a></li>
</ul>
</li>
<li><a href="#OSELAB5_B.3">Exercise 3 - The Block Bitmap</a></li>
<li><a href="#OSELAB5_B.4">Exercise 4 - File Operations</a></li>
<li><a href="#OSELAB5_B.5">Exercise 5, 6 - The File System Interface</a></li>
</ul>
</li>
<li><a href="#OSELAB5_C">Spawning Process</a><ul>
<li><a href="#OSELAB5_C.7">Exercise 7 - Implement spawn</a><ul>
<li><a href="#OSELAB5_C.7.CHALLENGE">Challenge - Implement Unix-style exec</a></li>
</ul>
</li>
<li><a href="#OSELAB5_C.8">Exercise 8 - Sharing library state across fork and spawn</a></li>
</ul>
</li>
<li><a href="#OSELAB5_D">The keyboard interface</a><ul>
<li><a href="#OSELAB5_D.9">Exercise 9 - Responsing to externel interrupt</a></li>
</ul>
</li>
<li><a href="#OSELAB5_E">Shell</a><ul>
<li><a href="#OSELAB5_E.10">Exercise 10 - Implement I/O redirection</a></li>
</ul>
</li>
<li><a href="#OSELAB5_REFERENCES">REFERENCES</a></li>
</ul>
<a id="more"></a>

<hr>
<h1><span id="file-system-preliminaries"><span id="OSELAB5_A">File system preliminaries</span></span><a href="#file-system-preliminaries" class="header-anchor">#</a></h1><hr>
<h2><span id="block-layout-and-struct-file"><span id="OSELAB5_A.1">Block Layout and struct File</span></span><a href="#block-layout-and-struct-file" class="header-anchor">#</a></h2><p>JOS kernel实现的是简化版文件系统，相较于常规文件系统FILE-INODE(META DATA)-BLOCKS的模式，JOS kernel直接使用file的meta data来记录该文件所占用的Blocks信息，即FILE(META DATA)-BLOCKS的模式： </p><div align="center"><img src="https://s2.ax1x.com/2020/01/31/13lpHP.png" alt="图 1-1 File结构示意图"></div><code>struct File</code>也存储在磁盘上，需要找到一个特定的File，就得有一个根File，它能够直接被文件系统获取而不用查找，这个根目录记录在Super Block，在具体实现中，编号为1的Block作为Super Block（Block 0存储boot loader，文件系统不使用block 0），除此之外，还需要记录每个Block的使用情况，将Block 2作为bitmap用来记录Block的占用空闲情况： <div align="center"><img src="https://s2.ax1x.com/2020/01/31/13lk9g.png" alt="图 1-2 文件系统BLOCKS布局"></div>JOS kernel直接将磁盘至多3GB空间直接加载到内存当中，并且将其映射到线性地址空间<code>DISKMAP</code> ~ <code>DISKMAP + 3GB</code>，<strong>换而言之，在文件系统的地址空间中，<code>DISKMAP</code> ~ <code>DISKMAP + 3GB</code>就是磁盘内容，这部分只有文件系统能够访问，不会与其它User Environment共享</strong>，并且由于文件系统地址空间中的Block与磁盘内容直接映射，因此能够直接直接通过线性地址计算出Block Number，从而找到需要加载的Sector，例如线性地址va，其对应的BLock Number为<code>(va - DISKMAP) / PGSIZE</code>，相应地，如果文件系统在va产生了page fault，就需要加载磁盘sector编号为<code>BLKSECTORS * (va - DISKMAP) / PGSIZE</code>为起始sector的共<code>BLKSECTORS</code>个sector即可。在JOS的文件系统中，Block size是4096 bytes，因此BLKSECTORS是<code>4096 / 512 = 8</code>。<p></p>
<hr>
<h2><span id="design-philosophy-of-file-system"><span id="OSELAB5_A.2">Design Philosophy of File System</span></span><a href="#design-philosophy-of-file-system" class="header-anchor">#</a></h2><p>实际操作系统将文件系统作为内核代码实现，因此进程调用文件系统接口最终都会陷入内核态来处理，然而，在JOS中，整个文件系统本质上是一个特殊的User Environment，Normal User Environment调用的文件系统接口是通过IPC实现。<strong>换而言之，可以将JOS的文件系统看作一个Server，而Normal User Environment都是Client，Client通过IPC向Server发送请求，而Server则始终准备着接受来自Client的请求。</strong></p>
<p>文件系统是JOS运行的第一个Environment，在kern/init.c:i386_init中直接创建文件系统。文件系统的main入口函数在fs/serv.c中，它完成的主要工作是：</p>
<ol>
<li><code>fs/serv.c:serve_init</code> - <strong>openfile table的初始化，以及file descriptor的地址划分</strong>。</li>
<li><code>fs/fs.c:fs_init</code> - 调用<code>fs/bc.c:bc_init</code>，校验Super Block和bitmap Block的合法性并记录它们的虚拟地址到全局变量<code>super</code>和<code>bitmap</code>。<ul>
<li><code>fs/bc.c:bc_init</code> - 正如<a href="#OSELAB5_A.1">Block Layout and struct File</a>中所讨论的一样，当我们知晓了需要加载的Block的虚拟地址va之后，就能够得到它对应的Block Number为<code>(va - DISKMAP) / PGSIZE</code>，相应地，该虚拟地址对应地page就需要从disk中加载serctor编号为<code>BLKSECTORS * (va - DISKMAP) / PGSIZE</code>到<code>BLKSECTORS * (va - DISKMAP) / PGSIZE + BLKSECTORS</code>的sector到内存。因此我们需要<strong>设置page fault handler</strong>，就像我们在实现fork中做的一样。除此之外，<code>bc.c</code>还需要<strong>完成Super Block和bitmap Block的初始化</strong>。</li>
</ul>
</li>
<li><code>fs/serv.c:serve</code> - 接受Regular User Environment发送的请求，并且调用相应的handler来处理请求，再返回响应。但是文件系统同一时间只能够处理一个请求，效率不高。可以考虑多几个File system environment，但是这样需要对一些资源加锁，例如File descriptor，openfile table等，从而避免并发错误。</li>
</ol>
<p>在提供给用户使用的接口方面，统一接口在lib/fd.c中，同时JOS将一些子系统抽象成Device，例如File Device，Pipe Device以及后面需要实现的Network Driver，Dev结构体包括了Dev id以及相应的处理函数指针:</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Dev</span> {</span></span><br><span class="line">	<span class="hljs-keyword">int</span> dev_id;</span><br><span class="line">	<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dev_name;</span><br><span class="line">	<span class="hljs-keyword">ssize_t</span> (*dev_read)(struct Fd *fd, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> len);</span><br><span class="line">	<span class="hljs-keyword">ssize_t</span> (*dev_write)(struct Fd *fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> len);</span><br><span class="line">	<span class="hljs-keyword">int</span> (*dev_close)(struct Fd *fd);</span><br><span class="line">	<span class="hljs-keyword">int</span> (*dev_stat)(struct Fd *fd, struct Stat *stat);</span><br><span class="line">	<span class="hljs-keyword">int</span> (*dev_trunc)(struct Fd *fd, <span class="hljs-keyword">off_t</span> length);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>通过Devices的抽象以及File Descriptor，<strong>统一了用户接口</strong>（在lib/fd.c中），并且提供了高度的可定制性和可插拔性。我绘制了一个示意图，<strong>Client与Server端都划分了三层</strong>： </p><div align="center"><img src="https://s2.ax1x.com/2020/01/31/13OKcn.png" alt="图 1-3 文件系统分层结构"></div>注解：<p></p>
<ul>
<li>USER API - lib/fd.c</li>
<li>DEVICE - For instance - devfile:lib/file.c; devpipe:lib/pipe.c; devcons:lib/console.c</li>
<li>IPC - lib/ipc.c</li>
<li>SERVER - fs/serv.c</li>
<li>FILE SYSTEM - fs/fs.c</li>
</ul>
<p>以devfile的read操作为例，其Control flow如下所示：</p>
<figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">      Regular env           FS env</span><br><span class="line">   +---------------+   +---------------+</span><br><span class="line">   |<span class="hljs-string">      read     </span>|<span class="hljs-string">   </span>|<span class="hljs-string">   file_read   </span>|</span><br><span class="line">   |<span class="hljs-string">   (lib/fd.c)  </span>|<span class="hljs-string">   </span>|<span class="hljs-string">   (fs/fs.c)   </span>|</span><br><span class="line">...|<span class="hljs-string">.......</span>|<span class="hljs-string">.......</span>|<span class="hljs-string">...</span>|<span class="hljs-string">.......^.......</span>|<span class="hljs-string">...............</span></span><br><span class="line"><span class="hljs-string">   </span>|<span class="hljs-string">       v       </span>|<span class="hljs-string">   </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string"> RPC mechanism</span></span><br><span class="line"><span class="hljs-string">   </span>|<span class="hljs-string">  devfile_read </span>|<span class="hljs-string">   </span>|<span class="hljs-string">  serve_read   </span>|</span><br><span class="line">   |<span class="hljs-string">  (lib/file.c) </span>|<span class="hljs-string">   </span>|<span class="hljs-string">  (fs/serv.c)  </span>|</span><br><span class="line">   |<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">   </span>|<span class="hljs-string">       ^       </span>|</span><br><span class="line">   |<span class="hljs-string">       v       </span>|<span class="hljs-string">   </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|</span><br><span class="line">   |<span class="hljs-string">     fsipc     </span>|<span class="hljs-string">   </span>|<span class="hljs-string">     serve     </span>|</span><br><span class="line">   |<span class="hljs-string">  (lib/file.c) </span>|<span class="hljs-string">   </span>|<span class="hljs-string">  (fs/serv.c)  </span>|</span><br><span class="line">   |<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">   </span>|<span class="hljs-string">       ^       </span>|</span><br><span class="line">   |<span class="hljs-string">       v       </span>|<span class="hljs-string">   </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|</span><br><span class="line">   |<span class="hljs-string">   ipc_send    </span>|<span class="hljs-string">   </span>|<span class="hljs-string">   ipc_recv    </span>|</span><br><span class="line">   |<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">   </span>|<span class="hljs-string">       ^       </span>|</span><br><span class="line">   +-------|<span class="hljs-string">-------+   +-------</span>|<span class="hljs-string">-------+</span></span><br><span class="line"><span class="hljs-string">           </span>|<span class="hljs-string">                   </span>|</span><br><span class="line">           +-------------------+</span><br></pre></td></tr></tbody></table></figure>

<p><strong>任何操作都是通过File Descriptor作为媒介来实现的</strong>，并且File Descriptor是File System Environment与Regular User Environment<strong>共享</strong>的：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Fd</span> {</span></span><br><span class="line">	<span class="hljs-keyword">int</span> fd_dev_id;</span><br><span class="line">	<span class="hljs-keyword">off_t</span> fd_offset;</span><br><span class="line">	<span class="hljs-keyword">int</span> fd_omode;</span><br><span class="line">	<span class="hljs-keyword">union</span> {</span><br><span class="line">		<span class="hljs-comment">// File server files</span></span><br><span class="line">		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">FdFile</span> <span class="hljs-title">fd_file</span>;</span></span><br><span class="line">	};</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>通过Fd的dev_id能够找到相应的Devices，并且调用其处理函数，而fd_file则是OpenFile的索引，控制最终转移到File system时，能够通过fd_file拿到OpenFile，而OpenFile结构体中保留了File指针，在File System Environment的地址空间中，能通过该File指针获取到相应的struct File的引用：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">OpenFile</span> {</span></span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> o_fileid;	<span class="hljs-comment">// file id</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">File</span> *<span class="hljs-title">o_file</span>;</span>	<span class="hljs-comment">// mapped descriptor for open file</span></span><br><span class="line">	<span class="hljs-keyword">int</span> o_mode;		<span class="hljs-comment">// open mode</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Fd</span> *<span class="hljs-title">o_fd</span>;</span>	<span class="hljs-comment">// Fd page</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>文件系统环境和Regular User Environment之间的结构如下所示： </p><div><img src="https://s2.ax1x.com/2020/01/31/13lPN8.png" alt="图 1-4 文件系统内存布局以及File Descriptor共享原理示意图"></div><p></p>
<hr>
<h1><span id="the-file-system"><span id="OSELAB5_B">The File System</span></span><a href="#the-file-system" class="header-anchor">#</a></h1><hr>
<h2><span id="exercise-1-disk-access"><span id="OSELAB5_B.1">Exercise 1 - Disk Access</span></span><a href="#exercise-1-disk-access" class="header-anchor">#</a></h2><p>正如上面所讨论的，文件系统是JOS创建的第一个environment，为了将其与Regular user environment区别，需要将其类型设置为ENV_TYPE_FS：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENV_CREATE(fs_fs, ENV_TYPE_FS);</span><br></pre></td></tr></tbody></table></figure>

<p>并且需要为其赋予I/O权限:</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">void</span></span><br><span class="line">env_create(<span class="hljs-keyword">uint8_t</span> *binary, <span class="hljs-keyword">enum</span> EnvType type)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">env</span>;</span></span><br><span class="line">	<span class="hljs-keyword">int32_t</span> flag;</span><br><span class="line">	<span class="hljs-keyword">if</span>((flag = env_alloc(&env, (<span class="hljs-keyword">envid_t</span>)<span class="hljs-number">0</span>)) < <span class="hljs-number">0</span>){</span><br><span class="line">		panic(<span class="hljs-string">"env_create:%e"</span>, flag);</span><br><span class="line">	}</span><br><span class="line">	env->env_type = type;</span><br><span class="line">	<span class="hljs-comment">// If this is the file server (type == ENV_TYPE_FS) give it I/O privileges.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(type == ENV_TYPE_FS){</span><br><span class="line">		env->env_tf.tf_eflags |= FL_IOPL_3;</span><br><span class="line">	}</span><br><span class="line">	load_icode(env, binary); <span class="hljs-comment">// restore this binary image to corresponding memory.</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h3><span id="question"><span id="OSELAB5_B.1.QUESTION">Question</span></span><a href="#question" class="header-anchor">#</a></h3><blockquote>
<p>1.Do you have to do anything else to ensure that this I/O privilege setting is saved and restored properly when you subsequently switch from one environment to another? Why?</p>
</blockquote>
<p>当然不用，eflags寄存器也会在发生switch的时候自动保存到env->env_tf中。即trap时会自动保存这些寄存器的值。</p>
<hr>
<h2><span id="exercise-2-the-block-cache"><span id="OSELAB5_B.2">Exercise 2 - The Block Cache</span></span><a href="#exercise-2-the-block-cache" class="header-anchor">#</a></h2><p>设置page fault handler以便能够从disk加载fault va对应的Block到内存：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="line">bc_pgfault(struct UTrapframe *utf)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">void</span> *addr = (<span class="hljs-keyword">void</span> *) utf->utf_fault_va;</span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> blockno = ((<span class="hljs-keyword">uint32_t</span>)addr - DISKMAP) / BLKSIZE;</span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// Check that the fault was within the block cache region</span></span><br><span class="line">	<span class="hljs-keyword">if</span> (addr < (<span class="hljs-keyword">void</span>*)DISKMAP || addr >= (<span class="hljs-keyword">void</span>*)(DISKMAP + DISKSIZE))</span><br><span class="line">		panic(<span class="hljs-string">"page fault in FS: eip %08x, va %08x, err %04x"</span>,</span><br><span class="line">		      utf->utf_eip, addr, utf->utf_err);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// Sanity check the block number.</span></span><br><span class="line">	<span class="hljs-keyword">if</span> (super && blockno >= super->s_nblocks)</span><br><span class="line">		panic(<span class="hljs-string">"reading non-existent block %08x\n"</span>, blockno);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// Allocate a page in the disk map region, read the contents</span></span><br><span class="line">	<span class="hljs-comment">// of the block from the disk into that page.</span></span><br><span class="line">	addr = (<span class="hljs-keyword">void</span> *)ROUNDDOWN((<span class="hljs-keyword">uintptr_t</span>)addr, PGSIZE);</span><br><span class="line">	<span class="hljs-keyword">if</span>((r = sys_page_alloc(<span class="hljs-number">0</span>, addr, (PTE_U | PTE_P | PTE_W))) < <span class="hljs-number">0</span>){</span><br><span class="line">		panic(<span class="hljs-string">"sys_page_alloc:%e"</span>, r);</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-keyword">if</span>((r = ide_read(blockno * BLKSECTS, addr, BLKSECTS)) < <span class="hljs-number">0</span>){</span><br><span class="line">		panic(<span class="hljs-string">"ide_read:%e"</span>, r);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// Clear the dirty bit for the disk block page since we just read the</span></span><br><span class="line">	<span class="hljs-comment">// block from disk</span></span><br><span class="line">	<span class="hljs-keyword">if</span> ((r = sys_page_map(<span class="hljs-number">0</span>, addr, <span class="hljs-number">0</span>, addr, uvpt[PGNUM(addr)] & PTE_SYSCALL)) < <span class="hljs-number">0</span>)</span><br><span class="line">		panic(<span class="hljs-string">"in bc_pgfault, sys_page_map: %e"</span>, r);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// Check that the block we read was allocated. </span></span><br><span class="line">	<span class="hljs-keyword">if</span> (bitmap && block_is_free(blockno))</span><br><span class="line">		panic(<span class="hljs-string">"reading free block %08x\n"</span>, blockno);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>实现flush_block以便能够将内存中的Block同步回DISK，达到数据持久化的效果：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">void</span></span><br><span class="line">flush_block(<span class="hljs-keyword">void</span> *addr)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> blockno = ((<span class="hljs-keyword">uint32_t</span>)addr - DISKMAP) / BLKSIZE;</span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">if</span> (addr < (<span class="hljs-keyword">void</span>*)DISKMAP || addr >= (<span class="hljs-keyword">void</span>*)(DISKMAP + DISKSIZE))</span><br><span class="line">		panic(<span class="hljs-string">"flush_block of bad va %08x"</span>, addr);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// LAB 5: Your code here.</span></span><br><span class="line">	addr = (<span class="hljs-keyword">void</span> *)ROUNDDOWN((<span class="hljs-keyword">uintptr_t</span>)addr, PGSIZE);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// If the block isn't in the block cache,just not do anything.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(!va_is_mapped(addr) || !va_is_dirty(addr))<span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// bit dirty was set,we should write it back to dist.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>((r = ide_write(blockno * BLKSECTS, addr, BLKSECTS)) < <span class="hljs-number">0</span>){</span><br><span class="line">		panic(<span class="hljs-string">"ide_write:%e"</span>, r);</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// After we write back this dirty block to disk,we should clear the PTE_D bit.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>((r = sys_page_map(<span class="hljs-number">0</span>, addr, <span class="hljs-number">0</span>, addr, uvpt[PGNUM(addr)] & PTE_SYSCALL)) < <span class="hljs-number">0</span>){</span><br><span class="line">		panic(<span class="hljs-string">"int flush_block, sys_page_map:%e"</span>, r);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h3><span id="challenge-block-eviction-policy"><span id="OSELAB5_B.2.CHALLENGE">Challenge - Block Eviction Policy</span></span><a href="#challenge-block-eviction-policy" class="header-anchor">#</a></h3><p>实现起来倒不难，但是我着实没明白PTE_A和dirty Block不是相互矛盾的吗，如果是dirty block，它的PTE_A也必然被设置了呀。其实JOS压根就不需要Eviction Policy，因为JOS的文件系统与DISK是一对一的，不存在Block满了之后，还能加载新的Block的情况，但是也可以说是为了不让文件系统占用过多的物理内存。我实现的仅仅是释放掉没有被访问过的Block的超简单策略：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lab 5's challenge : implement eviction policy for block cache.</span></span><br><span class="line"><span class="hljs-keyword">void</span></span><br><span class="line">evict_block_force(<span class="hljs-keyword">void</span> *addr)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> blockno = ((<span class="hljs-keyword">uint32_t</span>)addr - DISKMAP) / BLKSIZE;</span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">if</span>(addr < (<span class="hljs-keyword">void</span> *)DISKMAP || addr >= (<span class="hljs-keyword">void</span> *)(DISKMAP + DISKSIZE)){</span><br><span class="line">		panic(<span class="hljs-string">"evict_block_force of bad va %08x"</span>, addr);</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// ignore boot sector,super block and bitmap block.</span></span><br><span class="line">	<span class="hljs-comment">// if the block isn't in the block cache,just not do anything.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(blockno <= <span class="hljs-number">2</span> || !va_is_mapped(addr))<span class="hljs-keyword">return</span>;</span><br><span class="line">	<span class="hljs-comment">// flush this block if PTE_D flag was set before you evict this block to disk from memory.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(uvpt[PGNUM(addr)] & PTE_D){</span><br><span class="line">		flush_block(addr);</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// enture that addr was page-aligned,otherwise sys_page_unmap will return error -E_INVAL.</span></span><br><span class="line">	addr = (<span class="hljs-keyword">void</span> *)ROUNDDOWN(addr, PGSIZE);</span><br><span class="line">	<span class="hljs-comment">// evict this block to disk.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>((r = sys_page_unmap(<span class="hljs-number">0</span>, addr)) < <span class="hljs-number">0</span>){</span><br><span class="line">		panic(<span class="hljs-string">"evict_block_force:sys_page_unmap:%e"</span>, r);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// if only_not_accessed was true, this function will only evict those block</span></span><br><span class="line"><span class="hljs-comment">// loaded into memory but has never been accessed.In contrast, it will evict</span></span><br><span class="line"><span class="hljs-comment">// all block except for block number with 0,1,2.</span></span><br><span class="line"><span class="hljs-keyword">void</span></span><br><span class="line">block_evict_policy(<span class="hljs-keyword">bool</span> only_not_accessed)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> blockno, nblocks = DISKSIZE / BLKSIZE;</span><br><span class="line">	<span class="hljs-keyword">for</span>(blockno = <span class="hljs-number">3</span>; blockno < nblocks; ++blockno){</span><br><span class="line">		<span class="hljs-keyword">if</span>((!only_not_accessed) || (!(uvpt[PGNUM(diskaddr(blockno))] & PTE_A))){</span><br><span class="line">			evict_block_force(diskaddr(blockno));</span><br><span class="line">			<span class="hljs-keyword">if</span>(!only_not_accessed)cprintf(<span class="hljs-string">"[ALL BLOCKS EVICTION POLICY]block with blockno %d was evicted forcelly.\n"</span>);</span><br><span class="line">			<span class="hljs-keyword">else</span> cprintf(<span class="hljs-string">"[ONLY NOT ACCESSED EVICTION POLICY]block with block no %d was evicted.\n"</span>);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2><span id="exercise-3-the-block-bitmap"><span id="OSELAB5_B.3">Exercise 3 - The Block Bitmap</span></span><a href="#exercise-3-the-block-bitmap" class="header-anchor">#</a></h2><p>分配Block并且设置bitmap以追踪block使用情况：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span></span><br><span class="line">alloc_block(<span class="hljs-keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-comment">// The bitmap consists of one or more blocks.  A single bitmap block</span></span><br><span class="line">	<span class="hljs-comment">// contains the in-use bits for BLKBITSIZE blocks.  There are</span></span><br><span class="line">	<span class="hljs-comment">// super->s_nblocks blocks in the disk altogether.</span></span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> i;</span><br><span class="line">	<span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i < super->s_nblocks; ++i){</span><br><span class="line">		<span class="hljs-keyword">if</span>(block_is_free(i)){</span><br><span class="line">			bitmap[i / <span class="hljs-number">32</span>] &= ~(<span class="hljs-number">1</span> << (i % <span class="hljs-number">32</span>)); <span class="hljs-comment">// mark this bit as zero which means in use.</span></span><br><span class="line">			<span class="hljs-keyword">return</span> i;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">return</span> -E_NO_DISK;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2><span id="exercise-4-file-operations"><span id="OSELAB5_B.4">Exercise 4 - File Operations</span></span><a href="#exercise-4-file-operations" class="header-anchor">#</a></h2><p><code>file_block_walk</code>有一个小trick，在注释中已说明：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">file_block_walk(struct File *f, <span class="hljs-keyword">uint32_t</span> filebno, <span class="hljs-keyword">uint32_t</span> **ppdiskbno, <span class="hljs-keyword">bool</span> alloc)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> blockno;</span><br><span class="line">	<span class="hljs-keyword">if</span>(filebno >= NDIRECT + NINDIRECT)<span class="hljs-keyword">return</span> -E_INVAL;</span><br><span class="line">	<span class="hljs-keyword">if</span>(filebno < NDIRECT){</span><br><span class="line">		*ppdiskbno = f->f_direct + filebno;</span><br><span class="line">		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-keyword">if</span>(!(f->f_indirect)){</span><br><span class="line">		<span class="hljs-comment">// get here means that we need to allocate an indirect block,</span></span><br><span class="line">		<span class="hljs-comment">// but alloc was 0.</span></span><br><span class="line">		<span class="hljs-keyword">if</span>(!alloc)<span class="hljs-keyword">return</span> -E_NOT_FOUND;</span><br><span class="line">		<span class="hljs-comment">// Now we could allocate an indirect block by using alloc_block.</span></span><br><span class="line">		<span class="hljs-keyword">if</span>((blockno = alloc_block()) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> -E_NO_DISK;</span><br><span class="line">		f->f_indirect = blockno;</span><br><span class="line">		<span class="hljs-comment">// claer the block we allocated above.</span></span><br><span class="line">		<span class="hljs-built_in">memset</span>(diskaddr(f->f_indirect), <span class="hljs-number">0</span>, BLKSIZE);</span><br><span class="line">		flush_block(diskaddr(f->f_indirect));</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// There is a trick:f->f_indirect is an block number while f->direct is an virtual address.</span></span><br><span class="line">	<span class="hljs-comment">// That's why we need to convert f->f_indirect to virtual address firstly.</span></span><br><span class="line">	*ppdiskbno = ((<span class="hljs-keyword">uint32_t</span> *)diskaddr(f->f_indirect)) + (filebno - NDIRECT);</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以及通过索引返回该索引对应的block虚拟地址，注意这个索引是相对于这个特定的File而言的：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span></span><br><span class="line">file_get_block(struct File *f, <span class="hljs-keyword">uint32_t</span> filebno, <span class="hljs-keyword">char</span> **blk)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> *ppdiskno;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// value of r might be 0, -E_INVAL, -E_NO_DISK.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>((r = file_block_walk(f, filebno, &ppdiskno, <span class="hljs-number">1</span>)) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> r;</span><br><span class="line">	<span class="hljs-comment">// *ppdiskno is zero means that we should allocate a blobk.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(!(*ppdiskno)){</span><br><span class="line">		<span class="hljs-keyword">if</span>((r = alloc_block()) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> -E_NO_DISK;</span><br><span class="line">		*ppdiskno = r;</span><br><span class="line">	}</span><br><span class="line">	*blk = (<span class="hljs-keyword">char</span> *)diskaddr(*ppdiskno);</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2><span id="exercise-5-6-the-file-system-interface"><span id="OSELAB5_B.5">Exercise 5, 6 - The File System Interface</span></span><a href="#exercise-5-6-the-file-system-interface" class="header-anchor">#</a></h2><p>Exercise 5,6实际上就是实现图1-3所示的SERVER层的handler function，它需要调用File System提供的接口才能完成功能：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span></span><br><span class="line">serve_read(<span class="hljs-keyword">envid_t</span> envid, <span class="hljs-keyword">union</span> Fsipc *ipc)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Fsreq_read</span> *<span class="hljs-title">req</span> = &<span class="hljs-title">ipc</span>-><span class="hljs-title">read</span>;</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Fsret_read</span> *<span class="hljs-title">ret</span> = &<span class="hljs-title">ipc</span>-><span class="hljs-title">readRet</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">if</span> (debug)</span><br><span class="line">		cprintf(<span class="hljs-string">"serve_read %08x %08x %08x\n"</span>, envid, req->req_fileid, req->req_n);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">OpenFile</span> *<span class="hljs-title">openFile</span>;</span></span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line">	<span class="hljs-keyword">if</span>((r = openfile_lookup(envid, req->req_fileid, &openFile)) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> r;</span><br><span class="line">	<span class="hljs-keyword">if</span>((r = file_read(openFile->o_file, ret->ret_buf, req->req_n, openFile->o_fd->fd_offset)) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> r;</span><br><span class="line">	openFile->o_fd->fd_offset += r;</span><br><span class="line">	<span class="hljs-keyword">return</span> r;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">int</span></span><br><span class="line">serve_write(<span class="hljs-keyword">envid_t</span> envid, struct Fsreq_write *req)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">if</span> (debug)</span><br><span class="line">		cprintf(<span class="hljs-string">"serve_write %08x %08x %08x\n"</span>, envid, req->req_fileid, req->req_n);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">OpenFile</span> *<span class="hljs-title">openFile</span>;</span></span><br><span class="line">	<span class="hljs-keyword">int</span> r, t = <span class="hljs-number">0</span>;</span><br><span class="line">	<span class="hljs-keyword">if</span>((r = openfile_lookup(envid, req->req_fileid, &openFile)) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> r;</span><br><span class="line">	t = req->req_n > PGSIZE?PGSIZE:req->req_n;</span><br><span class="line">	<span class="hljs-keyword">if</span>((r = file_write(openFile->o_file, req->req_buf, t, openFile->o_fd->fd_offset)) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> r;</span><br><span class="line">	openFile->o_fd->fd_offset += r;</span><br><span class="line">	<span class="hljs-keyword">return</span> r;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h1><span id="spawning-process"><span id="OSELAB5_C">Spawning Process</span></span><a href="#spawning-process" class="header-anchor">#</a></h1><hr>
<h2><span id="exercise-7-implement-spawn"><span id="OSELAB5_C.7">Exercise 7 - Implement spawn</span></span><a href="#exercise-7-implement-spawn" class="header-anchor">#</a></h2><p>spawn由parent environment为child environment进行初始化，因此不会有任何问题，但是要在用户态下实现Unix-style exec是很有难度的。</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">sys_env_set_trapframe(<span class="hljs-keyword">envid_t</span> envid, struct Trapframe *tf)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-comment">// Remember to check whether the user has supplied us with a good</span></span><br><span class="line">	<span class="hljs-comment">// address!</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">theEnv</span>;</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(envid2env(envid, &theEnv, <span class="hljs-number">1</span>) < <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> -E_BAD_ENV;</span><br><span class="line">	<span class="hljs-comment">// cprintf("this tf va@0x%p\n", tf);</span></span><br><span class="line">	user_mem_assert(theEnv, tf, <span class="hljs-keyword">sizeof</span>(struct Trapframe), PTE_U);</span><br><span class="line">	<span class="hljs-comment">// Clear IOPL bits.</span></span><br><span class="line">	tf->tf_eflags &= ~FL_IOPL_MASK;</span><br><span class="line">	<span class="hljs-comment">// Interrupts enabled.</span></span><br><span class="line">	tf->tf_eflags |= FL_IF;</span><br><span class="line">	<span class="hljs-comment">// code protection level 3(CPL 3).</span></span><br><span class="line">	tf->tf_cs |= GD_UT | <span class="hljs-number">3</span>;</span><br><span class="line">	<span class="hljs-comment">// set envid's trap frame to tf.</span></span><br><span class="line">	theEnv->env_tf = *tf;</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其实这里我卡了很久，就是faultio测试用例无法通过，我确实花了非常多的时间来定位bug，解决bug，最后发现是问题在于CPU的Task State Segment设置有一点问题，我没有设置TSS的IO permission bit map的偏移量，从而产生问题。</p>
<blockquote>
<p>I/O map base address field-contains a 16-bit offset from the base of the TSS to the I/O permission bit map and interrupt redirection bitmap.When present,these maps are  stored in the TSS at the higher addresses.The I/O map base address points to the beginning of the I/O permission bit map and the end of the interrupt redirection bit map.See <strong>Chapter 13</strong>,”Input/Output,”in the Intel 64 and IA-32 Architectures Software Developer’s Manual,Volume 1,for more information about the I/O permission bit map.See <strong>Section 15.3</strong>,”Interrupt and Exception Handling in Virtual-8086 Mode,”for a detailed description of the interrupt redirection bit map. </p><div align="center"><img src="https://s2.ax1x.com/2020/01/31/18398U.md.png" alt="图 3-1 一个棘手的bug"></div>换而言之，这个bug就是I/O Map Base设置为0所导致的，因此，解决这个bug只需要将I/O Base设置为sizof(struct Taskstate)即可：<p></p>
</blockquote>
<p>修复I/O permission的bug，在trap_init_percpu(kern/trap.c)中设置:</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thiscpu->cpu_ts.ts_iomb = <span class="hljs-keyword">sizeof</span>(struct Taskstate);</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h3><span id="challenge-implement-unix-style-exec"><span id="OSELAB5_C.7.CHALLENGE">Challenge - Implement Unix-style exec</span></span><a href="#challenge-implement-unix-style-exec" class="header-anchor">#</a></h3><p>在用户环境中实现exec的<strong>难点</strong>在哪里？我们需要做些什么？</p>
<ul>
<li>难点就是我们不能够直接将需要加载的代码和数据映射到当前Environment正在使用的虚拟页面上，如果这么做了，后续exec的代码就无法执行了，因为映射关系改变了，处理器执行指令进行地址转换的时候，会定位到未知的地方。因此我们需要找到一个暂存空间，将exec需要加载的代码和数据加载到这个暂存空间，然后通过系统调用陷入内核态，让内核代码为该执行exec的Environment完成最终代码和数据的装载（或者说新的内存映射）。总而言之，两个关键点，一是预留一个暂存空间用来临时存储exec需要装载的数据和代码，二是最终需要实现一个系统调用完成最终代码和数据的装载或者说新的内存映射（可以考虑在系统调用中用memmove直接将暂存空间的内容复制到调用exec的Environment的相应的地方）</li>
<li>上面是我的初始想法，实现了一版之后，出现了许多很难解决的问题，于是我参考了xv6的内核态下实现exec的流程，最终成功完成了这个challenge。原理简单来说就是创建临时的page directory，随后将exec指定的内容加载到内存并且映射到这个临时的page directory，完成装载之后再替换page directory并且释放旧的page directory，page table以及相应的page。</li>
</ul>
<p>实现主要通过三个核心的系统调用：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// allocate a new page as this environmnt's page directory and map</span></span><br><span class="line"><span class="hljs-comment">// it to va temporarily.</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">sys_exec_alloc_pgdir(<span class="hljs-keyword">void</span> *va)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">currentEnv</span>;</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pageInfo</span> = <span class="hljs-title">NULL</span>;</span></span><br><span class="line">	<span class="hljs-keyword">pde_t</span> *new_pgdir;</span><br><span class="line"></span><br><span class="line">	envid2env(<span class="hljs-number">0</span>, &currentEnv, <span class="hljs-number">1</span>);</span><br><span class="line">	assert(currentEnv);</span><br><span class="line">	<span class="hljs-comment">// step 1) we should check that whether the page correspondingly to pgdir_temp</span></span><br><span class="line">	<span class="hljs-comment">//         is present or not.At the same time,we have to ensure that the virtual</span></span><br><span class="line">	<span class="hljs-comment">//         address va is page-aligned.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(((<span class="hljs-keyword">uintptr_t</span>)va & (PGSIZE - <span class="hljs-number">1</span>)) || page_lookup(currentEnv->env_pgdir, va, <span class="hljs-literal">NULL</span>)){</span><br><span class="line">		cprintf(<span class="hljs-string">"[DEBUG]sys_exec_alloc_pgdir:va is now mapped or va was not page aligned.\n"</span>);</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_INVAL;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// step 2) allocate a new page as this environment's page directory.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(!(pageInfo = page_alloc(ALLOC_ZERO))){</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_NO_MEM;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// step 3) map the new page to va temporarily.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(page_insert(currentEnv->env_pgdir, pageInfo, va, (PTE_W | PTE_P | PTE_U)) < <span class="hljs-number">0</span>){</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_NO_MEM;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// step 4) copy this environment's old pgdir here just like what we have done before.</span></span><br><span class="line">	<span class="hljs-comment">//         Don't forget to increment its ref counter.</span></span><br><span class="line">	<span class="hljs-comment">//         Most importantly,it's necessary switch page directory for that we are now</span></span><br><span class="line">	<span class="hljs-comment">//         in kernel mode.</span></span><br><span class="line">	<span class="hljs-comment">//cprintf("[INFO]Before cr3 is %p.\n", rcr3());</span></span><br><span class="line">	lcr3(PADDR(currentEnv->env_pgdir));</span><br><span class="line">	<span class="hljs-comment">//cprintf("[INFO]After cr3 is %p.\n", rcr3());</span></span><br><span class="line">	<span class="hljs-built_in">memcpy</span>(va, kern_pgdir, PGSIZE);</span><br><span class="line">	++pageInfo->pp_ref;</span><br><span class="line">	<span class="hljs-comment">//lcr3(PADDR(kern_pgdir));</span></span><br><span class="line">	<span class="hljs-comment">//cprintf("[INFO]Finally cr3 is %p.\n", rcr3());</span></span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// lab 5's challenge - implement Unix-Like exec.</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">sys_exec_map(<span class="hljs-keyword">pde_t</span> *pg_dir, <span class="hljs-keyword">void</span> *srcva, <span class="hljs-keyword">void</span> *dstva, <span class="hljs-keyword">int</span> perm)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pageInfo</span> = <span class="hljs-title">NULL</span>;</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">currentEnv</span>;</span></span><br><span class="line">	<span class="hljs-keyword">int32_t</span> leastPerm = (PTE_U | PTE_P);</span><br><span class="line">	envid2env(<span class="hljs-number">0</span>, &currentEnv, <span class="hljs-number">1</span>);</span><br><span class="line">	assert(currentEnv);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// step 0)</span></span><br><span class="line">	<span class="hljs-keyword">if</span>((<span class="hljs-keyword">uintptr_t</span>)srcva >= UTOP || (<span class="hljs-keyword">uintptr_t</span>)dstva >= UTOP || ((<span class="hljs-keyword">uintptr_t</span>)srcva & (PGSIZE - <span class="hljs-number">1</span>)) || ((<span class="hljs-keyword">uintptr_t</span>)dstva & (PGSIZE - <span class="hljs-number">1</span>))){</span><br><span class="line">		cprintf(<span class="hljs-string">"[DEBUG]sys_exec_map:step 0 failed.\n"</span>);</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_INVAL;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// step 1) check pg_dir present.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(!page_lookup(currentEnv->env_pgdir, pg_dir, <span class="hljs-literal">NULL</span>)){</span><br><span class="line">		cprintf(<span class="hljs-string">"[DEBUG]sys_exec_map:pg_dir not present.\n"</span>);</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_INVAL;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// step 2) check source page present.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>(!( pageInfo = page_lookup(currentEnv->env_pgdir, srcva, <span class="hljs-literal">NULL</span>))){</span><br><span class="line">		cprintf(<span class="hljs-string">"[DEBUG]sys_exec_map:step 2 failed.\n"</span>);</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_INVAL;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// step 3)</span></span><br><span class="line">	<span class="hljs-keyword">if</span>((perm & leastPerm) != leastPerm || (perm & (~PTE_SYSCALL))){</span><br><span class="line">		cprintf(<span class="hljs-string">"[DEBUG]sys_exec_map:step 3 failed,permisson denied.\n"</span>);</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_INVAL;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// step 4) map pageInfo to dstva.</span></span><br><span class="line">	<span class="hljs-comment">// cprintf("[DEBUG]pg_dir is %p and dstva is %p\n", pg_dir, dstva);</span></span><br><span class="line">	<span class="hljs-keyword">return</span> page_insert(pg_dir, pageInfo, dstva, perm);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// lab 5's challenge - implement Unix-Like exec.</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">sys_exec_replace_pgdir(<span class="hljs-keyword">pde_t</span> *pg_dir, <span class="hljs-keyword">uintptr_t</span> esp, <span class="hljs-keyword">uintptr_t</span> e_entry)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pageInfo</span> = <span class="hljs-title">NULL</span>;</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">currentEnv</span> = <span class="hljs-title">NULL</span>;</span></span><br><span class="line">	<span class="hljs-keyword">pde_t</span> *old_pgdir;</span><br><span class="line">	<span class="hljs-keyword">pte_t</span> *pt;</span><br><span class="line">	<span class="hljs-keyword">uint32_t</span> pdeno, pteno;</span><br><span class="line">	<span class="hljs-keyword">physaddr_t</span> pa;</span><br><span class="line"></span><br><span class="line">	envid2env(<span class="hljs-number">0</span>, &currentEnv, <span class="hljs-number">1</span>);</span><br><span class="line">	assert(currentEnv);</span><br><span class="line">	<span class="hljs-keyword">if</span>(!(pageInfo = page_lookup(currentEnv->env_pgdir, (<span class="hljs-keyword">void</span> *)pg_dir, <span class="hljs-literal">NULL</span>))){</span><br><span class="line">		cprintf(<span class="hljs-string">"[DEBUG]sys_exec_replace_pgdir:page_lookup:pageInfo is null.\n"</span>);</span><br><span class="line">		<span class="hljs-keyword">return</span> -E_INVAL;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// save the old page directory.</span></span><br><span class="line">	old_pgdir = currentEnv->env_pgdir;</span><br><span class="line">	currentEnv->env_pgdir = (<span class="hljs-keyword">pde_t</span> *)page2kva(pageInfo);</span><br><span class="line">	<span class="hljs-comment">// UVPT maps the env's own page table read-only.</span></span><br><span class="line">	currentEnv->env_pgdir[PDX(UVPT)] = PADDR(currentEnv->env_pgdir) | PTE_P | PTE_U;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// we have replaced page directory.However,we didn't free old page directory and page table,</span></span><br><span class="line">	<span class="hljs-comment">// that's what we are going to do next.</span></span><br><span class="line">	<span class="hljs-keyword">for</span>(pdeno = <span class="hljs-number">0</span>; pdeno < PDX(UTOP); ++pdeno){</span><br><span class="line">		<span class="hljs-keyword">if</span>(!(old_pgdir[pdeno] & PTE_P))</span><br><span class="line">			<span class="hljs-keyword">continue</span>;</span><br><span class="line">		<span class="hljs-comment">// find the pa and va of the page table.</span></span><br><span class="line">		pa = PTE_ADDR(old_pgdir[pdeno]);</span><br><span class="line">		pt = (<span class="hljs-keyword">pte_t</span> *)KADDR(pa);</span><br><span class="line">		<span class="hljs-comment">// unmap all PTEs in this page table.</span></span><br><span class="line">		<span class="hljs-keyword">for</span>(pteno = <span class="hljs-number">0</span>; pteno <= PTX(~<span class="hljs-number">0</span>); ++pteno){</span><br><span class="line">			<span class="hljs-keyword">if</span>(pt[pteno] & PTE_P)</span><br><span class="line">				page_remove(old_pgdir, PGADDR(pdeno, pteno, <span class="hljs-number">0</span>));</span><br><span class="line">		}</span><br><span class="line">		<span class="hljs-comment">// free the page table itself.</span></span><br><span class="line">		old_pgdir[pdeno] = <span class="hljs-number">0</span>;</span><br><span class="line">		page_decref(pa2page(pa));</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// free the page directory.</span></span><br><span class="line">	pa = PADDR(old_pgdir);</span><br><span class="line">	old_pgdir = <span class="hljs-number">0</span>;</span><br><span class="line">	page_decref(pa2page(pa));</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// modify some status of this environment.</span></span><br><span class="line">	currentEnv->env_tf.tf_esp = esp;</span><br><span class="line">	currentEnv->env_tf.tf_eip = e_entry;</span><br><span class="line">	env_run(currentEnv);</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// never get here,just eliminate compiling error.</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>除此之外，还需要修改一些地方，篇幅原因，完整实现可参考<a href="https://github.com/QinStaunch/MIT-6.828" target="_blank" rel="noopener">Github:YanTang Qin</a>的lab5dev分支：</p>
<ol>
<li><code>git checkout lab5dev</code>切换到lab5dev分支</li>
<li><code>git diff lab5</code></li>
</ol>
<p>这样就能够快速找到我为实现<code>exec</code>所做的修改了。</p>
<p>下图是实现的效果。可以看到我的测试程序使用了fork+execl的模式，子进程会加载testshell这个程序执行，可以看到完全符合预期！ </p><div align="center"><img src="https://s2.ax1x.com/2020/01/31/18ZCm8.gif" alt="图 3-1 Unix-Style exec效果演示"></div><p></p>
<p>以下是测试程序：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">void</span></span><br><span class="line">umain(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line">	cprintf(<span class="hljs-string">"hello, world!\n"</span>);</span><br><span class="line">	cprintf(<span class="hljs-string">"[BEFORE]parent environment %08x\n"</span>, thisenv->env_id);</span><br><span class="line">	<span class="hljs-keyword">if</span>((r = fork()) < <span class="hljs-number">0</span>){</span><br><span class="line">		cprintf(<span class="hljs-string">"[DEBUG]fork failed for %e.\n"</span>, r);</span><br><span class="line">		<span class="hljs-keyword">return</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// printe by parent and child environment.</span></span><br><span class="line">	cprintf(<span class="hljs-string">"[COMMON]environment %08x\n"</span>, thisenv->env_id);</span><br><span class="line">	<span class="hljs-keyword">if</span>(r > <span class="hljs-number">0</span>){</span><br><span class="line">		<span class="hljs-comment">// parent environment.</span></span><br><span class="line">		cprintf(<span class="hljs-string">"[PARENT]hello\n"</span>);</span><br><span class="line">	}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(r == <span class="hljs-number">0</span>){</span><br><span class="line">		<span class="hljs-comment">// child environment.</span></span><br><span class="line">		cprintf(<span class="hljs-string">"[CHILD]world!\n"</span>);</span><br><span class="line">		<span class="hljs-keyword">if</span>((r = execl(<span class="hljs-string">"testshell"</span>, <span class="hljs-string">"testshell"</span>, <span class="hljs-number">0</span>)) < <span class="hljs-number">0</span>){</span><br><span class="line">			panic(<span class="hljs-string">"[DEBUG]panic for %e"</span>, r);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	cprintf(<span class="hljs-string">"[PARENT]Oh!\n"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>有效输出结果（剔除了调试信息）：</p>
<figure class="highlight accesslog hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hello, world!</span><br><span class="line"><span class="hljs-string">[BEFORE]</span>parent environment <span class="hljs-number">00001001</span></span><br><span class="line"><span class="hljs-string">[COMMON]</span>environment <span class="hljs-number">00001001</span></span><br><span class="line"><span class="hljs-string">[COMMON]</span>environment <span class="hljs-number">00001002</span></span><br><span class="line"><span class="hljs-string">[PARENT]</span>hello</span><br><span class="line"><span class="hljs-string">[PARENT]</span>Oh!</span><br><span class="line"><span class="hljs-string">[CHILD]</span>world!</span><br><span class="line">running sh -x < testshell.sh | cat</span><br><span class="line">shell ran correctly</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，抛开并发运行带来的不确定性，输出结果完全符合预期。</p>
<hr>
<h2><span id="exercise-8-sharing-library-state-across-fork-and-spawn"><span id="OSELAB5_C.8">Exercise 8 - Sharing library state across fork and spawn</span></span><a href="#exercise-8-sharing-library-state-across-fork-and-spawn" class="header-anchor">#</a></h2><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">duppage(<span class="hljs-keyword">envid_t</span> envid, <span class="hljs-keyword">unsigned</span> pn)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">uintptr_t</span> pn_va = pn * PGSIZE;</span><br><span class="line">	<span class="hljs-keyword">if</span>(uvpt[pn] & PTE_SHARE){</span><br><span class="line">		<span class="hljs-keyword">if</span>((r = sys_page_map(<span class="hljs-number">0</span>, (<span class="hljs-keyword">void</span> *)pn_va, envid, (<span class="hljs-keyword">void</span> *)pn_va, uvpt[pn] & PTE_SYSCALL)) < <span class="hljs-number">0</span>){</span><br><span class="line">			panic(<span class="hljs-string">"sys_page_map:%e"</span>, r);</span><br><span class="line">		}</span><br><span class="line">	}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((uvpt[pn] & PTE_W) || (uvpt[pn] & PTE_COW)){</span><br><span class="line">		<span class="hljs-keyword">if</span>((r = sys_page_map(<span class="hljs-number">0</span>, (<span class="hljs-keyword">void</span> *)pn_va, envid, (<span class="hljs-keyword">void</span> *)pn_va, (PTE_COW | PTE_P | PTE_U))) < <span class="hljs-number">0</span>){</span><br><span class="line">			panic(<span class="hljs-string">"sys_page_map:%e"</span>, r);</span><br><span class="line">		}</span><br><span class="line">		<span class="hljs-keyword">if</span>((r = sys_page_map(<span class="hljs-number">0</span>, (<span class="hljs-keyword">void</span> *)pn_va, <span class="hljs-number">0</span>, (<span class="hljs-keyword">void</span> *)pn_va, (PTE_COW | PTE_P | PTE_U))) < <span class="hljs-number">0</span>){</span><br><span class="line">			panic(<span class="hljs-string">"sys_page_map:%e"</span>, r);</span><br><span class="line">		}</span><br><span class="line">	}<span class="hljs-keyword">else</span>{</span><br><span class="line">		<span class="hljs-keyword">if</span>((r = sys_page_map(<span class="hljs-number">0</span>, (<span class="hljs-keyword">void</span> *)pn_va, envid, (<span class="hljs-keyword">void</span> *)pn_va, PTE_P | PTE_U)) < <span class="hljs-number">0</span>){</span><br><span class="line">			panic(<span class="hljs-string">"sys_page_map:%e"</span>, r);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以及：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">copy_shared_pages(<span class="hljs-keyword">envid_t</span> child)</span><br><span class="line">{</span><br><span class="line">	<span class="hljs-keyword">uintptr_t</span> pageVa;</span><br><span class="line">	<span class="hljs-keyword">unsigned</span> pn;</span><br><span class="line">	<span class="hljs-keyword">int</span> r;</span><br><span class="line">	<span class="hljs-keyword">for</span>(pageVa = UTEXT; pageVa < UTOP; pageVa += PGSIZE){</span><br><span class="line">		pn = PGNUM(pageVa);</span><br><span class="line">		<span class="hljs-keyword">if</span>((uvpd[PDX(pageVa)] & PTE_P) && (uvpt[pn] & PTE_P) && (uvpt[pn] & PTE_SHARE)){</span><br><span class="line">			<span class="hljs-keyword">if</span>((r = sys_page_map(<span class="hljs-number">0</span>, (<span class="hljs-keyword">void</span> *)pageVa, child, (<span class="hljs-keyword">void</span> *)pageVa, uvpt[pn] & PTE_SYSCALL)) < <span class="hljs-number">0</span>){</span><br><span class="line">				panic(<span class="hljs-string">"copy_shared_pages:sys_page_map:%e"</span>, r);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h1><span id="the-keyboard-interface"><span id="OSELAB5_D">The keyboard interface</span></span><a href="#the-keyboard-interface" class="header-anchor">#</a></h1><hr>
<h2><span id="exercise-9-responsing-to-externel-interrupt"><span id="OSELAB5_D.9">Exercise 9 - Responsing to externel interrupt</span></span><a href="#exercise-9-responsing-to-externel-interrupt" class="header-anchor">#</a></h2><p>在trap_dispatch中添加上trap number对应的相应即可：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(tf->tf_trapno == (IRQ_OFFSET + IRQ_KBD)){</span><br><span class="line">	kbd_intr();</span><br><span class="line">	<span class="hljs-keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(tf->tf_trapno == (IRQ_OFFSET + IRQ_SERIAL)){</span><br><span class="line">	serial_intr();</span><br><span class="line">	<span class="hljs-keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h1><span id="shell"><span id="OSELAB5_E">Shell</span></span><a href="#shell" class="header-anchor">#</a></h1><hr>
<h2><span id="exercise-10-implement-i-o-redirection"><span id="OSELAB5_E.10">Exercise 10 - Implement I/O redirection</span></span><a href="#exercise-10-implement-i-o-redirection" class="header-anchor">#</a></h2><p>理解了文件系统的结构和接口之后不难：</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">case</span> <span class="hljs-string">'<'</span>:	<span class="hljs-comment">// Input redirection</span></span><br><span class="line">	<span class="hljs-comment">// Grab the filename from the argument list</span></span><br><span class="line">	<span class="hljs-keyword">if</span> (gettoken(<span class="hljs-number">0</span>, &t) != <span class="hljs-string">'w'</span>) {</span><br><span class="line">		cprintf(<span class="hljs-string">"syntax error: < not followed by word\n"</span>);</span><br><span class="line">		<span class="hljs-built_in">exit</span>();</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-comment">// Open 't' for reading as file descriptor 0</span></span><br><span class="line">	<span class="hljs-comment">// (which environments use as standard input).</span></span><br><span class="line">	<span class="hljs-comment">// We can't open a file onto a particular descriptor,</span></span><br><span class="line">	<span class="hljs-comment">// so open the file as 'fd',</span></span><br><span class="line">	<span class="hljs-comment">// then check whether 'fd' is 0.</span></span><br><span class="line">	<span class="hljs-comment">// If not, dup 'fd' onto file descriptor 0,</span></span><br><span class="line">	<span class="hljs-comment">// then close the original 'fd'.</span></span><br><span class="line">	<span class="hljs-keyword">if</span>((fd = open(t, O_RDONLY)) < <span class="hljs-number">0</span>){</span><br><span class="line">		<span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"fail to open %s for reason %e\n"</span>, t, fd);</span><br><span class="line">		<span class="hljs-built_in">exit</span>();</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-keyword">if</span>(fd != <span class="hljs-number">0</span>){</span><br><span class="line">		dup(fd, <span class="hljs-number">0</span>);</span><br><span class="line">		close(fd);</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-keyword">break</span>;</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h1><span id="references"><div align="center"><span id="OSELAB5_REFERENCES">REFERENCES</span></div></span><a href="#references" class="header-anchor">#</a></h1><p>【1】 <a href="https://pdos.csail.mit.edu/6.828/2018/readings/ia32/IA32-3A.pdf" target="_blank" rel="noopener">Intel® 64 and IA-32 Architectures Software Developer’s Manual</a><br>【2】 <a href="https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf" target="_blank" rel="noopener">xv6 - a simple, Unix-like teaching operating system</a><br>【3】 <a href="https://pdos.csail.mit.edu/6.828/2018/xv6/xv6-rev11.pdf" target="_blank" rel="noopener">xv6 source book - xv6 is a re−implementation of Dennis Ritchie’s and Ken Thompson’s Unix Version 6 (v6). </a></p>
</body></html>
        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/MIT6-828/">MIT6.828</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="/assets/img/ali_pay.jpg" alt="支付宝"></div>
</a>

                
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="/assets/img/weixin_pay.png" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/05/01/Lightweight-JSON-Parser-Based-on-C-cJSON/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">Lightweight JSON Parser Based on C -- cJSON</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2020/01/24/MIT-6-828-LAB4-Preemptive-Multitasking/">
                <span class="level-item">MIT-6.828-LAB4 Preemptive Multitasking</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/zh_CN/sdk.js#xfbml=1&version=v2.8";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-comments" data-width="100%" data-href="https://qinstaunch.github.io/2020/01/31/MIT-6-828-LAB5-File-system-Spawn-and-Shell/" data-num-posts="5"></div>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/avatar.png" alt="QinStaunch">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        QinStaunch
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        梦想是做出优秀的开源产品
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>四川成都</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        20
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        15
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        17
                    </p>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/QinStaunch" target="_blank">
                关注我</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/QinStaunch">
                
                <i class="fab fa-github"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">1</span>
        <span>Contents#</span>
        </a></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">2</span>
        <span>File system preliminaries#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">2.1</span>
        <span>Block Layout and struct File#</span>
        </a></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">2.2</span>
        <span>Design Philosophy of File System#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3</span>
        <span>The File System#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3.1</span>
        <span>Exercise 1 - Disk Access#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3.1.1</span>
        <span>Question#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3.2</span>
        <span>Exercise 2 - The Block Cache#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3.2.1</span>
        <span>Challenge - Block Eviction Policy#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3.3</span>
        <span>Exercise 3 - The Block Bitmap#</span>
        </a></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3.4</span>
        <span>Exercise 4 - File Operations#</span>
        </a></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">3.5</span>
        <span>Exercise 5, 6 - The File System Interface#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">4</span>
        <span>Spawning Process#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">4.1</span>
        <span>Exercise 7 - Implement spawn#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">4.1.1</span>
        <span>Challenge - Implement Unix-style exec#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">4.2</span>
        <span>Exercise 8 - Sharing library state across fork and spawn#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">5</span>
        <span>The keyboard interface#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">5.1</span>
        <span>Exercise 9 - Responsing to externel interrupt#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">6</span>
        <span>Shell#</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">6.1</span>
        <span>Exercise 10 - Implement I/O redirection#</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#undefined">
        <span class="has-mr-6">7</span>
        <span>REFERENCES#</span>
        </a></li></ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://leetcode-cn.com/u/qinstaunch/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">My LeetCode</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">leetcode-cn.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Framework/">
            <span class="level-start">
                <span class="level-item">Framework</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Framework/Mybatis/">
            <span class="level-start">
                <span class="level-item">Mybatis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Java/Java编程语言/">
            <span class="level-start">
                <span class="level-item">Java编程语言</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/algorithms/">
            <span class="level-start">
                <span class="level-item">algorithms</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/并发控制/">
            <span class="level-start">
                <span class="level-item">并发控制</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Unclassified/">
            <span class="level-start">
                <span class="level-item">Unclassified</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/操作系统/">
            <span class="level-start">
                <span class="level-item">操作系统</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">9</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/操作系统/MIT-6-828-OSE/">
            <span class="level-start">
                <span class="level-item">MIT-6.828-OSE</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/操作系统/csapp/">
            <span class="level-start">
                <span class="level-item">csapp</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/数据库/">
            <span class="level-start">
                <span class="level-item">数据库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/数据库/MySQL/">
            <span class="level-start">
                <span class="level-item">MySQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/设计模式/">
            <span class="level-start">
                <span class="level-item">设计模式</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/译文/">
            <span class="level-start">
                <span class="level-item">译文</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/译文/杂记/">
            <span class="level-start">
                <span class="level-item">杂记</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li></ul></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Algorithms/" style="font-size: 10px;">Algorithms</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/MIT6-828/" style="font-size: 20px;">MIT6.828</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 10px;">Mybatis</a> <a href="/tags/No-tags/" style="font-size: 13.33px;">No-tags</a> <a href="/tags/csapp/" style="font-size: 16.67px;">csapp</a> <a href="/tags/临界区/" style="font-size: 10px;">临界区</a> <a href="/tags/互斥/" style="font-size: 10px;">互斥</a> <a href="/tags/并发控制/" style="font-size: 10px;">并发控制</a> <a href="/tags/操作系统/" style="font-size: 10px;">操作系统</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/杂记译文/" style="font-size: 10px;">杂记译文</a> <a href="/tags/线程/" style="font-size: 10px;">线程</a> <a href="/tags/线程池/" style="font-size: 10px;">线程池</a> <a href="/tags/设计模式/" style="font-size: 16.67px;">设计模式</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2020/07/01/【译文】The-end-of-the-Redis-adventure-antirez/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="【译文】The end of the Redis adventure.antirez.">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-07-01T03:40:13.000Z">2020-07-01</time></div>
                    <a href="/2020/07/01/【译文】The-end-of-the-Redis-adventure-antirez/" class="title has-link-black-ter is-size-6 has-text-weight-normal">【译文】The end of the Redis adventure.antirez.</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/译文/">译文</a> / <a class="has-link-grey -link" href="/categories/译文/杂记/">杂记</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/05/01/Lightweight-JSON-Parser-Based-on-C-cJSON/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Lightweight JSON Parser Based on C -- cJSON">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-05-01T13:35:53.000Z">2020-05-01</time></div>
                    <a href="/2020/05/01/Lightweight-JSON-Parser-Based-on-C-cJSON/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Lightweight JSON Parser Based on C -- cJSON</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Unclassified/">Unclassified</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/31/MIT-6-828-LAB5-File-system-Spawn-and-Shell/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MIT-6.828-LAB5 File system,Spawn and Shell">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-31T14:36:42.000Z">2020-01-31</time></div>
                    <a href="/2020/01/31/MIT-6-828-LAB5-File-system-Spawn-and-Shell/" class="title has-link-black-ter is-size-6 has-text-weight-normal">MIT-6.828-LAB5 File system,Spawn and Shell</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/操作系统/">操作系统</a> / <a class="has-link-grey -link" href="/categories/操作系统/MIT-6-828-OSE/">MIT-6.828-OSE</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/24/MIT-6-828-LAB4-Preemptive-Multitasking/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MIT-6.828-LAB4 Preemptive Multitasking">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-24T03:52:57.000Z">2020-01-24</time></div>
                    <a href="/2020/01/24/MIT-6-828-LAB4-Preemptive-Multitasking/" class="title has-link-black-ter is-size-6 has-text-weight-normal">MIT-6.828-LAB4 Preemptive Multitasking</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/操作系统/">操作系统</a> / <a class="has-link-grey -link" href="/categories/操作系统/MIT-6-828-OSE/">MIT-6.828-OSE</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/16/MIT-6-828-LAB3-User-Environments/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MIT-6.828-LAB3 User Environments">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-16T04:32:08.000Z">2020-01-16</time></div>
                    <a href="/2020/01/16/MIT-6-828-LAB3-User-Environments/" class="title has-link-black-ter is-size-6 has-text-weight-normal">MIT-6.828-LAB3 User Environments</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/操作系统/">操作系统</a> / <a class="has-link-grey -link" href="/categories/操作系统/MIT-6-828-OSE/">MIT-6.828-OSE</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">七月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">五月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Algorithms/">
                        <span class="tag">Algorithms</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MIT6-828/">
                        <span class="tag">MIT6.828</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mybatis/">
                        <span class="tag">Mybatis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/No-tags/">
                        <span class="tag">No-tags</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/csapp/">
                        <span class="tag">csapp</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/临界区/">
                        <span class="tag">临界区</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/互斥/">
                        <span class="tag">互斥</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发控制/">
                        <span class="tag">并发控制</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/操作系统/">
                        <span class="tag">操作系统</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/杂记译文/">
                        <span class="tag">杂记译文</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程/">
                        <span class="tag">线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程池/">
                        <span class="tag">线程池</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/进程/">
                        <span class="tag">进程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.png" alt="MIT-6.828-LAB5 File system,Spawn and Shell" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 坚定qinyantang.&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                <br>
                <span id="busuanzi_container_site_uv">
                共<span id="busuanzi_value_site_uv">0</span>个访客
                </span>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="My Github" href="https://github.com/QinStaunch">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>

<script>
var IcarusThemeSettings = {
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>



    
    
<script src="/js/animation.js"></script>

    
    
<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>

    
    
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>

    
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>
    
    
<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>

    
    
    
    
    
    
    
    
    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>